#!/bin/sh

set -e

. /etc/default/openmediavault
. /usr/share/openmediavault/scripts/helper-functions

case "$1" in
configure)
    if ! omv_config_exists "/config/services/sabnzbd"; then
        echo "Initial configuration."
        object="<enable>0</enable>"
        object="${object}<showtab>0</showtab>"
        omv_config_add_element "/config/services" "sabnzbd" "${object}" true
    fi

    if ! grep -q "^sabnzbd:" /etc/passwd; then
        echo "Adding sabnzbd user..."
        useradd --no-create-home --groups users --no-user-group --shell /usr/sbin/nologin sabnzbd
    else
        echo "sabnzbd user already exists."
    fi

    chown -R sabnzbd:users /opt/SABnzbd
    chown -R sabnzbd:users /etc/init.d/sabnzbd

    if [ ! -e /var/lib/dpkg/info/unrar.list ]; then
    	RUNNING=`expr "$(uname -m)"`
	if [ "$RUNNING" == "x86_64" ]; then
		cd /tmp
		wget http://http.us.debian.org/debian/pool/non-free/u/unrar-nonfree/unrar_4.1.4-1_amd64.deb > /dev/null 2>&1
		dpkg -i unrar_4.1.4-1_amd64.deb > /dev/null 2>&1
		rm unrar_4.1.4-1_amd64.deb > /dev/null 2>&1
	elif [ "$RUNNING" == "i686" ]; then
		cd /tmp
		wget http://http.us.debian.org/debian/pool/non-free/u/unrar-nonfree/unrar_4.1.4-1_i386.deb > /dev/null 2>&1
		dpkg -i unrar_4.1.4-1_i386.deb > /dev/null 2>&1
		rm unrar_4.1.4-1_i386.deb > /dev/null 2>&1
	fi
    fi

    ;;
abort-upgrade|abort-remove|abort-deconfigure)
    ;;
*)
    echo "postinst called with unknown argument" >&2
    exit 1
    ;;
esac

exit 0
